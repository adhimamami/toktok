name: RDP via Ngrok

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ”½ Download & Extract Ngrok
        run: |
          Write-Host "ğŸš€ Downloading Ngrok..."
          curl -Lo ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip

          if (-Not (Test-Path "ngrok.zip")) {
            Write-Host "âŒ ERROR: Ngrok download failed!"
            exit 1
          }

          Write-Host "âœ… Ngrok downloaded successfully!"

          Write-Host "ğŸ“¦ Extracting Ngrok..."
          Expand-Archive -Path "ngrok.zip" -DestinationPath "ngrok" -Force

          if (-Not (Test-Path ".\ngrok\ngrok.exe")) {
            Write-Host "âŒ ERROR: Ngrok executable not found after extraction!"
            exit 1
          }

          Write-Host "âœ… Ngrok extracted successfully!"
        shell: pwsh

      - name: ğŸ”‘ Authenticate Ngrok
        run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        shell: pwsh

      - name: ğŸ› Enable Remote Desktop
        run: |
          Write-Host "ğŸ”“ Enabling RDP access..."
          # Aktifkan RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          # Izinkan koneksi melalui firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # Pastikan User Authentication aktif (sesuaikan jika diperlukan)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          Write-Host "âœ… Remote Desktop enabled!"
        shell: pwsh

      - name: ğŸ›  Set RDP Password
        run: |
          Write-Host "ğŸ”‘ Setting RDP password..."
          $Password = ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Write-Host "âœ… RDP password set!"
        shell: pwsh

      - name: ğŸš€ Start Ngrok Tunnel
        run: |
          Write-Host "ğŸš€ Starting Ngrok tunnel..."
          Start-Process -NoNewWindow -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389"
        shell: pwsh

      - name: â³ Wait for Ngrok Tunnel to be Available
        run: |
          $maxRetries = 30
          $tunnelUrl = ""
          for ($i = 0; $i -lt $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -UseBasicParsing -Uri http://127.0.0.1:4040/api/tunnels -TimeoutSec 5 | ConvertFrom-Json
              $tunnel = $response.tunnels | Where-Object { $_.proto -eq "tcp" }
              if ($tunnel -and $tunnel.public_url) {
                $tunnelUrl = $tunnel.public_url
                break
              }
            }
            catch {
              Write-Host "Waiting for ngrok tunnel to be available... (Attempt $($i + 1) of $maxRetries)"
            }
            Start-Sleep -Seconds 5
          }
          if (-not $tunnelUrl) {
            Write-Host "âŒ ERROR: Ngrok tunnel not available after waiting."
            exit 1
          }
          Write-Host "âœ… Ngrok tunnel established: $tunnelUrl"
          Write-Host "ğŸŒ RDP Address: $tunnelUrl"
          Write-Host "ğŸ‘¤ Username: runneradmin"
          Write-Host "ğŸ”‘ Password: P@ssw0rd!"
        shell: pwsh

      - name: ğŸ›¡ Keep Session Alive
        run: |
          Write-Host "â³ Keeping session alive..."
          while ($true) { Start-Sleep -Seconds 3600 }
        shell: pwsh
