name: RDP via Ngrok (Error 0x4 Fix)

on:
  workflow_dispatch:

jobs:
  rdp_setup:
    runs-on: windows-latest

    steps:
    - name: Setup Ngrok
      run: |
        # Download & ekstrak Ngrok
        curl -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
        tar -xf ngrok.zip -C ngrok/
        if (-not (Test-Path ngrok/ngrok.exe)) { exit 1 }

    - name: Configure RDP
      run: |
        # Nonaktifkan NLA (Penyebab Utama 0x4)
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

        # Enable RDP & Buka Firewall
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        New-NetFirewallRule -Name "RDP_NGROK" -DisplayName "RDP via Ngrok" -Protocol TCP -LocalPort 3389 -Action Allow

        # Restart Service RDP
        Restart-Service TermService -Force

    - name: Create User
      run: |
        $user = "GHAUser"
        $password = ConvertTo-SecureString "SuperSecretP@ss!2024" -AsPlainText -Force
        New-LocalUser -Name $user -Password $password -AccountNeverExpires
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

    - name: Start Ngrok (TCP 3389)
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        ./ngrok/ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
        
        # Jalankan Ngrok dengan log
        Start-Process -FilePath "./ngrok/ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -RedirectStandardOutput ngrok.log -PassThru
        
        # Tunggu tunnel aktif (30 detik timeout)
        $timeout = 30
        $startTime = Get-Date
        while (-not (Test-Path ngrok.log) {
            if (((Get-Date) - $startTime).TotalSeconds -gt $timeout) { exit 1 }
            Start-Sleep -Seconds 2
        }
        
        # Ambil URL dari log
        $tcpUrl = Get-Content ngrok.log | Select-String "tcp://(.+)" | ForEach-Object { $_.Matches.Groups[1].Value }
        if (-not $tcpUrl) { exit 1 }
        
        Write-Host "========================================"
        Write-Host "âœ… RDP READY! Gunakan informasi berikut:"
        Write-Host "Alamat: $tcpUrl"
        Write-Host "User: GHAUser"
        Write-Host "Password: SuperSecretP@ss!2024"
        Write-Host "========================================"

    - name: Keep Alive
      run: while ($true) { Start-Sleep -Seconds 3600 }
