name: RDP via Ngrok

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
    
    - name: ğŸ”½ Download & Extract Ngrok
      run: |
        Write-Host "ğŸš€ Downloading Ngrok..."
        curl -Lo ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip

        if (-Not (Test-Path "ngrok.zip")) {
          Write-Host "âŒ ERROR: Ngrok download failed!"
          exit 1
        }

        Write-Host "âœ… Ngrok downloaded successfully!"

        Write-Host "ğŸ“¦ Extracting Ngrok..."
        7z x ngrok.zip -o. -y

        if (-Not (Test-Path ".\ngrok.exe")) {
          Write-Host "âŒ ERROR: Ngrok executable not found after extraction!"
          exit 1
        }

        Write-Host "âœ… Ngrok extracted successfully!"
      shell: pwsh

    - name: ğŸ”‘ Authenticate Ngrok
      run: .\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      shell: pwsh

    - name: ğŸ› Enable Remote Desktop
      run: |
        Write-Host "ğŸ”“ Enabling RDP access..."
        
        # Mengaktifkan RDP di Registry
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        
        # Mengaktifkan aturan firewall untuk RDP
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Memastikan User Authentication diaktifkan
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

        Write-Host "âœ… Remote Desktop enabled!"
      shell: pwsh

    - name: ğŸ›  Set RDP Password
      run: |
        Write-Host "ğŸ”‘ Setting RDP password..."
        $Password = ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force
        Set-LocalUser -Name "runneradmin" -Password $Password
        Write-Host "âœ… RDP password set!"
      shell: pwsh

    - name: ğŸ”„ Start Ngrok Tunnel
      run: |
        Write-Host "ğŸš€ Starting Ngrok tunnel..."
        Start-Process -NoNewWindow -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389"
      shell: pwsh

    - name: â³ Wait for Ngrok to Initialize
      run: Start-Sleep -s 10
      shell: pwsh

    - name: ğŸŒ Get Ngrok Tunnel Info
      run: |
        Write-Host "ğŸ” Fetching Ngrok tunnel details..."
        
        $ngrok_tunnel = (Invoke-WebRequest -UseBasicParsing -Uri http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json).tunnels | Where-Object {$_.proto -eq "tcp"}

        if (-Not $ngrok_tunnel.public_url) {
          Write-Host "âŒ ERROR: Failed to fetch Ngrok tunnel URL!"
          exit 1
        }

        Write-Host "âœ… Ngrok tunnel established!"
        Write-Host "ğŸŒ RDP Address: $($ngrok_tunnel.public_url)"
        Write-Host "ğŸ‘¤ Username: runneradmin"
        Write-Host "ğŸ”‘ Password: P@ssw0rd!"
      shell: pwsh

    - name: ğŸ›¡ Keep Session Alive
      run: |
        Write-Host "â³ Keeping session alive..."
        while ($true) { Start-Sleep -s 3600 }
      shell: pwsh
